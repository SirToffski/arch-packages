pkgbase=pango+clang
pkgname=(pango+clang pango-docs+clang)
pkgver=1.48.6
pkgrel=1
epoch=1
pkgdesc="A library for layout and rendering of text"
url="https://www.pango.org/"
arch=(x86_64)
license=(LGPL)
depends=(libthai cairo libxft harfbuzz fribidi)
makedepends=(gobject-introspection help2man git meson gi-docgen)
checkdepends=(ttf-dejavu cantarell-fonts noto-fonts noto-fonts-emoji)
_commit=61763238b548d717d0772f31467ad7e9b6a557ae
source=(
  "git+https://gitlab.gnome.org/GNOME/pango.git#commit=${_commit}"
  "0001-fix-test.patch"
)
sha256sums=(
  'SKIP'
  'd74df5b325007d02c3054a9e2a623327d0d195adf18d0ee41689672c27657cdb'
)

_extra_lto_flag=""

prepare() {

  if clang --version 2>/dev/null | grep -iq "clang\s*version\s*[0-9]" && ld.lld --version 2>/dev/null | grep -iq "LLD\s*[0-9]"; then
    _extra_lto_flag='-D b_lto_mode=thin'
  fi

  cd "${srcdir:?}/pango" || (
    echo -e "\E[1;31mCan't cd to ${srcdir:?}/pango directory! Prepare Failed! \E[0m"
    exit 1
  )

  git apply -3 ../0001-fix-test.patch

}

pkgver() {

  cd "${srcdir:?}/pango" || (
    echo -e "\E[1;31mCan't cd to ${srcdir:?}/pango directory! PkgVer Failed! \E[0m"
    exit 1
  )

  git describe --tags | sed 's/-/+/g'

}

build() {

  meson setup pango build \
    --prefix /usr \
    --libexecdir lib \
    --sbindir bin \
    --auto-features enabled \
    --wrap-mode nodownload \
    -D debug=false \
    -D optimization=2 \
    -D b_ndebug=true \
    -D b_lto=true ${_extra_lto_flag} \
    -D b_pie=true \
    -D default_library=both \
    -D introspection=enabled \
    -D gtk_doc=true

  meson compile -C build

}

check() {

  meson test -C build --print-errorlogs || true

}

package_pango+clang() {

  provides=(pango libpango{,cairo,ft2,xft}-1.0.so)
  conflicts=('pango' "pango=${pkgver}")

  meson install -C build --destdir "${pkgdir:?}"

  mkdir -p doc/usr/share
  mv {"${pkgdir:?}",doc}/usr/share/doc

}

package_pango-docs+clang() {

  pkgdesc+=" (documentation)"
  depends=('pango+clang')
  provides=('pango-docs' "pango-docs=${pkgver}")
  conflicts=('pango-docs')

  mv doc/* "${pkgdir:?}"

}
