pkgbase=qt5-base+clang
pkgname=(qt5-base+clang qt5-xcb-private-headers+clang)
pkgver=5.15.2+kde+r210
pkgrel=1
_commit=663d240a18f5acac82fd2bd0fd4a33c4f47b260a
arch=('x86_64')
url='https://www.qt.io'
license=('GPL3' 'LGPL3' 'FDL' 'custom')
pkgdesc='A cross-platform application and UI framework'
depends=('libjpeg-turbo' 'xcb-util-keysyms' 'xcb-util-renderutil' 'libgl' 'fontconfig' 'xdg-utils'
  'shared-mime-info' 'xcb-util-wm' 'libxrender' 'libxi' 'sqlite' 'xcb-util-image' 'mesa'
  'tslib' 'libinput' 'libxkbcommon-x11' 'libproxy' 'libcups' 'double-conversion' 'md4c')
makedepends=('libfbclient' 'mariadb-libs' 'unixodbc' 'postgresql-libs' 'alsa-lib' 'gst-plugins-base-libs'
  'gtk3' 'libpulse' 'cups' 'freetds' 'vulkan-headers' 'git')
optdepends=('qt5-svg: to use SVG icon themes'
  'qt5-wayland: to run Qt applications in a Wayland session'
  'qt5-translations: for some native UI translations'
  'postgresql-libs: PostgreSQL driver'
  'mariadb-libs: MariaDB driver'
  'unixodbc: ODBC driver'
  'libfbclient: Firebird/iBase driver'
  'freetds: MS SQL driver'
  'gtk3: GTK platform plugin'
  'perl: for fixqt4headers and syncqt')
conflicts=('qtchooser')
groups=('qt' 'qt5')

source=(
  "git+https://invent.kde.org/qt/qt/qtbase#commit=${_commit}"
  qt5-base-cflags.patch
  qt5-base-nostrip.patch
  qt5-base-mariadb-10.6.patch
  qt5-base-cxxflag.patch
  qt5-base-gcc11.patch
  qtbase-emit-qscreen-geometry-changed-when-logical-dpi-changes.patch
  qtbase-everywhere-src-5.14.2-no_relocatable.patch
  qtbase-hidpi_scale_at_192.patch
  qtbase-multilib_optflags.patch
  qtbase-qmake_LFLAGS.patch
)

sha256sums=('SKIP'
  'cf707cd970650f8b60f8897692b36708ded9ba116723ec8fcd885576783fe85c'
  '4b93f6a79039e676a56f9d6990a324a64a36f143916065973ded89adc621e094'
  'dde1c2c7300a6e05b12145f0c0b180991aa5929a4bf13c026eef6511593f357b'
  'ad4dc439bc23826b7f165b1e897d8544adff593254cb03061be397358a7163b0'
  '9378afd071ad5c0ec8f7aef48421e4b9fab02f24c856bee9c0951143941913c5'
  'b741134bd3ce7114ed08090e6415a0029cf35af7215d3d7dbc27d6d569f44e16'
  '1fed8b9e4eb5749e70d85d7678f08a5abc881e2a2ecab85fb21f59cb124500e5'
  '483672e86b7f971c7aa9b40eba45911166d6febf2162fa5be829537c23562805'
  '7a03cbccd88df0dd2c69783a113a30c3e49a341818e9f006a8d0da1927317e68'
  '5063b93e72e6737bcec64ec05a2306286f936c8e43dea2ba7b3cf145ed09bd34')

_llvm=0

pkgver() {

  cd "${srcdir:?}/qtbase" || (
    echo -e "\E[1;31mCan't cd to {srcdir:?}/qtbase directory! PkgVer Failed! \E[0m"
    exit 1
  )

  echo "5.15.2+kde+r$(git rev-list --count origin/5.15.2..${_commit})"

}

prepare() {

  if clang --version 2>/dev/null | grep -iq "clang\s*version\s*[0-9]" && ld.lld --version 2>/dev/null | grep -iq "LLD\s*[0-9]"; then
    _llvm=1
  fi

  cd "${srcdir:?}/qtbase" || (
    echo -e "\E[1;31mCan't cd to {srcdir:?}/qtbase directory! Prepare Failed! \E[0m"
    exit 1
  )

  git revert -n 6344955d17e17e2398720fe60c34cfc2a4a95208 # Revert version bump

  patch -p1 <../qt5-base-mariadb-10.6.patch
  patch -p1 <../qt5-base-nostrip.patch # Don't strip binaries with qmake
  patch -p1 <../qt5-base-cflags.patch  # Use system CFLAGS in qmake
  patch -p1 <../qt5-base-cxxflag.patch
  patch -p1 <../qt5-base-gcc11.patch

}

build() {

  cd "${srcdir:?}/qtbase" || (
    echo -e "\E[1;31mCan't cd to {srcdir:?}/qtbase directory! Build Failed! \E[0m"
    exit 1
  )

  if [[ ${_llvm} -eq 1 ]]; then

    CPPFLAGS=${CPPFLAGS/-D_FORTIFY_SOURCE=2/}
    CFLAGS=${CFLAGS/-fstack-protector-strong/}
    CXXFLAGS=${CXXFLAGS/-fstack-protector-strong/}
    ./configure -platform linux-clang \
      -confirm-license \
      -opensource -v \
      -prefix /usr \
      -docdir /usr/share/doc/qt \
      -headerdir /usr/include/qt \
      -archdatadir /usr/lib/qt \
      -datadir /usr/share/qt \
      -sysconfdir /etc/xdg \
      -examplesdir /usr/share/doc/qt/examples \
      -plugin-sql-{psql,mysql,sqlite,odbc,ibase} \
      -reduce-relocations \
      -ltcg \
      -system-zlib \
      -system-libjpeg \
      -system-libpng \
      -system-sqlite \
      -system-harfbuzz \
      -openssl-linked \
      -optimized-qmake \
      -no-feature-relocatable \
      -no-rpath \
      -no-separate-debug-info \
      -no-mimetype-database \
      -nomake examples \
      -dbus-linked \
      -journald

    make

  else

    ./configure -confirm-license -opensource -v \
      -prefix /usr \
      -docdir /usr/share/doc/qt \
      -headerdir /usr/include/qt \
      -archdatadir /usr/lib/qt \
      -datadir /usr/share/qt \
      -sysconfdir /etc/xdg \
      -examplesdir /usr/share/doc/qt/examples \
      -plugin-sql-{psql,mysql,sqlite,odbc,ibase} \
      -system-zlib \
      -system-libjpeg \
      -system-libpng \
      -system-sqlite \
      -system-harfbuzz \
      -openssl-linked \
      -optimized-qmake \
      -no-reduce-relocations \
      -no-feature-relocatable \
      -no-rpath \
      -no-separate-debug-info \
      -no-mimetype-database \
      -no-strip \
      -nomake examples \
      -dbus-linked \
      -journald

    make

  fi

}

package_qt5-base+clang() {

  pkgdesc='A cross-platform application and UI framework'
  conflicts=('qt5-base')
  provides=('qt5-base' "qt5-base=${pkgver}")

  cd "${srcdir:?}/qtbase" || (
    echo -e "\E[1;31mCan't cd to {srcdir:?}/qtbase directory! Package Failed! \E[0m"
    exit 1
  )

  make INSTALL_ROOT="${pkgdir:?}" install

  install -Dm644 LICENSE* -t "${pkgdir:?}"/usr/share/licenses/$pkgbase

  # Drop QMAKE_PRL_BUILD_DIR because reference the build dir
  find "${pkgdir:?}/usr/lib" -type f -name '*.prl' \
    -exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d' {} \;

  # Fix wrong qmake path in pri file
  sed -i "s|${srcdir:?}/qtbase|/usr|" \
    "${pkgdir:?}"/usr/lib/qt/mkspecs/modules/qt_lib_bootstrap_private.pri

  # Symlinks for backwards compatibility
  for b in "${pkgdir:?}"/usr/bin/*; do
    ln -s "$(basename "${b}")" "${pkgdir:?}/usr/bin/$(basename "${b}")-qt5"
  done
}

package_qt5-xcb-private-headers+clang() {

  pkgdesc='Private headers for Qt5 Xcb'
  depends=("qt5-base+clang=${pkgver}")

  conflicts=('qt5-xcb-private-headers')
  provides=('qt5-xcb-private-headers' "qt5-xcb-private-headers=${pkgver}")

  cd "${srcdir:?}/qtbase" || (
    echo -e "\E[1;31mCan't cd to {srcdir:?}/qtbase directory! Package Failed! \E[0m"
    exit 1
  )

  install -d -m755 "${pkgdir:?}/usr/include/qtxcb-private"
  cp -r src/plugins/platforms/xcb/*.h "${pkgdir:?}/usr/include/qtxcb-private/"

}
